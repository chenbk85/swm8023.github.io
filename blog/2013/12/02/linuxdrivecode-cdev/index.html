<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Linux设备驱动学习——简单字符设备驱动的实现 | Coding 4 Fun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在Linux内核中，字符驱动是最为基础的设备驱动。本文实现了一个最简单的字符设备驱动，支持简单的读写功能。与常规驱动不同，该设备实际上是一块虚拟的内存，并不能做任何真正有用的事情。">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux设备驱动学习——简单字符设备驱动的实现">
<meta property="og:url" content="http://vimersu.win/blog/2013/12/02/linuxdrivecode-cdev/index.html">
<meta property="og:site_name" content="Coding 4 Fun">
<meta property="og:description" content="在Linux内核中，字符驱动是最为基础的设备驱动。本文实现了一个最简单的字符设备驱动，支持简单的读写功能。与常规驱动不同，该设备实际上是一块虚拟的内存，并不能做任何真正有用的事情。">
<meta property="og:updated_time" content="2016-06-04T14:57:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux设备驱动学习——简单字符设备驱动的实现">
<meta name="twitter:description" content="在Linux内核中，字符驱动是最为基础的设备驱动。本文实现了一个最简单的字符设备驱动，支持简单的读写功能。与常规驱动不同，该设备实际上是一块虚拟的内存，并不能做任何真正有用的事情。">
  
    <link rel="alternative" href="/atom.xml" title="Coding 4 Fun" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/avator.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">Vimer Su</a></h1>
        </hgroup>

        
        <p class="header-subtitle">Dream it, Believe it, Do IT!</p>
        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="mailto:swm8023@gmail.com" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/swm8023" title="github">github</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                                <a class="fl douban" target="_blank" href="https://www.douban.com/people/swm8023/" title="douban">douban</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/AP/" style="font-size: 10px;">AP</a> <a href="/tags/Alcatraz/" style="font-size: 10px;">Alcatraz</a> <a href="/tags/Algorithm/" style="font-size: 17.5px;">Algorithm</a> <a href="/tags/Apache/" style="font-size: 10px;">Apache</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/Cmockery/" style="font-size: 10px;">Cmockery</a> <a href="/tags/DirectX-3D/" style="font-size: 12.5px;">DirectX 3D</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/I-O复用/" style="font-size: 10px;">I/O复用</a> <a href="/tags/Leetcode-OJ/" style="font-size: 15px;">Leetcode OJ</a> <a href="/tags/Libev/" style="font-size: 10px;">Libev</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/MAC/" style="font-size: 10px;">MAC</a> <a href="/tags/Makefile/" style="font-size: 15px;">Makefile</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/OSX/" style="font-size: 10px;">OSX</a> <a href="/tags/Octopress/" style="font-size: 12.5px;">Octopress</a> <a href="/tags/OpenGL/" style="font-size: 10px;">OpenGL</a> <a href="/tags/Proxy/" style="font-size: 10px;">Proxy</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Sublime-text3/" style="font-size: 10px;">Sublime text3</a> <a href="/tags/Tools/" style="font-size: 10px;">Tools</a> <a href="/tags/Vim/" style="font-size: 10px;">Vim</a> <a href="/tags/Xcode/" style="font-size: 10px;">Xcode</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/iconv/" style="font-size: 10px;">iconv</a> <a href="/tags/madwifi/" style="font-size: 12.5px;">madwifi</a> <a href="/tags/wlanconfig/" style="font-size: 10px;">wlanconfig</a> <a href="/tags/二叉树/" style="font-size: 10px;">二叉树</a> <a href="/tags/单元测试/" style="font-size: 10px;">单元测试</a> <a href="/tags/堆/" style="font-size: 10px;">堆</a> <a href="/tags/外接显示器/" style="font-size: 10px;">外接显示器</a> <a href="/tags/天天爱消除/" style="font-size: 10px;">天天爱消除</a> <a href="/tags/宏/" style="font-size: 10px;">宏</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a> <a href="/tags/游戏开发/" style="font-size: 12.5px;">游戏开发</a> <a href="/tags/线程同步/" style="font-size: 10px;">线程同步</a> <a href="/tags/结构体/" style="font-size: 10px;">结构体</a> <a href="/tags/驱动程序/" style="font-size: 12.5px;">驱动程序</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/swm8023">swm8023@github</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/swm8023">swm8023@csdn</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/swm8023/">swm8023@cnblogs</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/CSGrandeur/">CSGrandeur</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://hujiaweibujidao.github.io/">Hujiawei Bujidao</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.chinaunix.net/uid/28387257.html">Henrystark&#39;s CU blog</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://oxoo.org">OxOo社</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/staginner/">Staginner</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://zhangxc.com/">张学程</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://yangha.github.io/">小阳Space</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Hello World</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Vimer Su</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/avator.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Vimer Su</a></h1>
            </hgroup>
            
            <p class="header-subtitle">Dream it, Believe it, Do IT!</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="mailto:swm8023@gmail.com" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/swm8023" title="github">github</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                        <a class="douban" target="_blank" href="https://www.douban.com/people/swm8023/" title="douban">douban</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-linuxdrivecode-cdev" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2013/12/02/linuxdrivecode-cdev/" class="article-date">
      <time datetime="2013-12-02T11:19:03.000Z" itemprop="datePublished">2013-12-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux设备驱动学习——简单字符设备驱动的实现
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/驱动程序/">驱动程序</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在Linux内核中，字符驱动是最为基础的设备驱动。本文实现了一个最简单的字符设备驱动，支持简单的读写功能。与常规驱动不同，该设备实际上是一块虚拟的内存，并不能做任何真正有用的事情。  </p>
<a id="more"></a>
<h2 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a><strong>准备知识</strong></h2><p>主要介绍一些与字符设备驱动相关的知识。  </p>
<h3 id="设备号"><a href="#设备号" class="headerlink" title="设备号"></a>设备号</h3><p>所谓一切皆文件，Linux也是通过文件来管理设备的，这些驱动文件被称为特殊文件，通常位于/dev目录下，我们可以通过<code>ls -l /dev</code>命令查看/dev下的文件，以下是其中的一部分<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">crw-------  1 root root      108,   0 Dec  2 12:44 ppp</span><br><span class="line">crw-------  1 root root       10,   1 Dec  2 12:44 psaux</span><br><span class="line">crw-rw-rw-  1 root tty         5,   2 Dec  2 20:19 ptmx</span><br><span class="line">drwxr-xr-x  2 root root             0 Dec  2  2013 pts</span><br><span class="line">brw-rw----  1 root disk        1,   0 Dec  2 12:44 ram0</span><br><span class="line">brw-rw----  1 root disk        1,   1 Dec  2 12:44 ram1</span><br><span class="line">brw-rw----  1 root disk        1,  10 Dec  2 12:44 ram10</span><br><span class="line">brw-rw----  1 root disk        1,  11 Dec  2 12:44 ram11</span><br><span class="line">brw-rw----  1 root disk        1,  12 Dec  2 12:44 ram12</span><br></pre></td></tr></table></figure></p>
<p>开头的第一个字母表示了设备类型，其中c代表的就是字符文件。而在修改日期前面，可以看到两个逗号隔开的数字，分别就是设备的主设备号和次设备号，主设备号表示管理该设备的驱动程序，而次设备号是驱动用来识别不同设备的，内核并不关心。通过<code>cat /proc/devices</code>命令，我们可以看到现在已经被用掉的主设备号。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Character devices:</span><br><span class="line">  1 mem</span><br><span class="line">  4 /dev/vc/0</span><br><span class="line">  4 tty</span><br><span class="line">  4 ttyS</span><br><span class="line">  5 /dev/tty</span><br><span class="line">  5 /dev/console</span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line">Block devices:</span><br><span class="line">  1 ramdisk</span><br><span class="line">259 blkext</span><br><span class="line">  7 loop</span><br><span class="line">  8 sd</span><br><span class="line">  9 md</span><br><span class="line"> 11 sr</span><br><span class="line"> 65 sd</span><br><span class="line">..........</span><br></pre></td></tr></table></figure></p>
<p>一般来说，主设备号和次设备号唯一的决定了一台设备以及它所使用的驱动程序。在内核中，<code>dev_t</code>类型用于保存设备编号，其中前12位是主设备号，后20位是次设备号，有三个与之相关的宏，我们可以用这三个宏在设备编号、主设备号、次设备号之间进行转换。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MAJOR(<span class="keyword">dev_t</span> dev);	<span class="comment">//根据设备号获得设备的主设备号</span></span><br><span class="line">MINOR(<span class="keyword">dev_t</span> dev); 	<span class="comment">//根据设备号获得设备的次设备号</span></span><br><span class="line">MKDEV(<span class="keyword">int</span> major, <span class="keyword">int</span> minor);	<span class="comment">//根据主设备号和次设备号来组成设备编号</span></span><br></pre></td></tr></table></figure></p>
<p>在加载我们的驱动程序时，首先要做的就是获得一个或多个设备编号以供使用，相关的函数有以下三个<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> first, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> *dev, <span class="keyword">unsigned</span> <span class="keyword">int</span> firstminor, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> first, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>这三个函数都可以同时对多个设备进行操作，最后一个函数用于释放设备号，会对first开始的一共count个设备号进行释放。需要区分的是前两个分配函数，第一个函数会分配从first开始一共分配count个设备，这些设备的主设备号都是指定的。但往往我们并不知道哪些主设备号已经被使用了，为此内核提供了第二个函数，内核动态分配一个主设备号给驱动并存在dev中返回，用户仅需指定需要的次设备号的开始数字及个数即可。分配函数中的name作为设备标识，分配后可以在<code>/proc/devices</code>文件中查看到。  </p>
<h3 id="字符设备注册"><a href="#字符设备注册" class="headerlink" title="字符设备注册"></a>字符设备注册</h3><p>内核使用<code>struct cdev</code>来表示字符设备，在内核对一个字符设备操作之前，必须分配一个这样的结构体。内核提供了以下几个函数对这个结构体进行分配和释放操作。需要注意的是，初始化后我们要手动分配<code>cdev</code>的<code>owner</code>为<code>THIS_MODULE</code>，以及文件操作函数表。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cdev_alloc();	<span class="comment">//返回一个struct cdev指针，用于动态内存初始化</span></span><br><span class="line">cdev_init(<span class="keyword">struct</span> cdev *cdev, <span class="keyword">struct</span> file_operations *fops);</span><br><span class="line">				<span class="comment">//用于静态内存初始化</span></span><br><span class="line">cdev_add(<span class="keyword">struct</span> cdev *dev, <span class="keyword">dev_t</span> num, <span class="keyword">unsigned</span> <span class="keyword">int</span> count);</span><br><span class="line">				<span class="comment">//告知内核，将设备添加到系统中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cdev_del</span><span class="params">(<span class="keyword">struct</span> cdev *dev)</span></span>;</span><br><span class="line">				<span class="comment">//将设备从系统中移除</span></span><br></pre></td></tr></table></figure></p>
<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p>对于字符设备，内核是调用<code>file_operations</code>中的函数指针来进行操作的，我们要将这些函数指针指向我们自己实现的函数，这其中的函数十分之多，而我们只用实现以下几种操作就可以实现简单读写了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int (*open)(struct inode *, struct file *);</span><br><span class="line">int (*release)(struct inode *, struct file *);</span><br><span class="line">size_t (*read)(struct file *, char __user *, size_t, loff_t *);</span><br><span class="line">size_t (*write)(struct file *, const char __user *, size_t, loff_t *);</span><br><span class="line">loff_t (*llseek)(struct file *, loff_t, int);</span><br></pre></td></tr></table></figure></p>
<p>其中<code>open</code>和<code>release</code>是打开和关闭文件时调用的函数，为空时文件将永远打开成功以及关闭成功。<code>read</code>和<code>write</code>就是读写操作了,<code>__user</code>代表这是一个用户空间地址，内核不能直接操作，需要调用<code>copy_to_user</code>和<code>copy_from_user</code>在用户空间地址和内核空间地址间进行拷贝，<code>loff_t</code>代表当前的文件偏移。最后的<code>llseek</code>是在<code>lseek</code>函数调用的，函数原型基本一样。  </p>
<p><code>file</code>结构并不是用户空间的<code>FILE</code>结构体，两者无任何关联。它由内核管理，指向一个打开的文件，我们需要使用的是它的<code>private_data</code>域，我们用这个域将file结构体与我们的设备关联起来。  </p>
<p><code>inode</code>应该都很熟悉，它与文件一一对应，有着大量字段，但对字符设备驱动编写有用的只有以下两个<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dev_t</span> i_rdev;			<span class="comment">//该文件的设备编号</span></span><br><span class="line"><span class="keyword">struct</span> cdev *i_cdev;	<span class="comment">//指向一个cdev结构体的指针</span></span><br></pre></td></tr></table></figure></p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a><strong>代码实现</strong></h2><h3 id="结构体与函数原型"><a href="#结构体与函数原型" class="headerlink" title="结构体与函数原型"></a>结构体与函数原型</h3><p><code>memcdev.h</code>的内容如下，该头文件主要包括三部分内容，一是可以在编译时决定是否打印调试信息的DEBUG宏，二是我们的字符设备结构体，三是相关文件操作函数原型。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MEMCDEV_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MEMCDEV_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DEBUG宏</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MEMC_DEBUG </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DPRINTF(fmt, ...) printk(KERN_DEBUG <span class="string">"MEMCDEV: "</span> fmt, ## __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DPRINTF(fmt, ...)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//字符设备结构体</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZE 4096</span></span><br><span class="line"><span class="keyword">struct</span> memcdev &#123;</span><br><span class="line">	<span class="keyword">char</span> mem[BUFSIZE];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">	<span class="keyword">struct</span> cdev cdev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开关函数原型</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">memcdev_open</span><span class="params">(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">memcdev_release</span><span class="params">(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *)</span></span>;</span><br><span class="line"><span class="comment">//读写函数原型</span></span><br><span class="line"><span class="keyword">ssize_t</span> memcdev_read(<span class="keyword">struct</span> file *, <span class="keyword">char</span> __user *, <span class="keyword">size_t</span> ,<span class="keyword">loff_t</span> *);</span><br><span class="line"><span class="keyword">ssize_t</span> memcdev_write(<span class="keyword">struct</span> file *, <span class="keyword">const</span> <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line"><span class="comment">//修改当前读写指针函数</span></span><br><span class="line"><span class="keyword">loff_t</span> memcdev_lseek(<span class="keyword">struct</span> file *, <span class="keyword">loff_t</span>, <span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="Begin"><a href="#Begin" class="headerlink" title="Begin"></a>Begin</h3><p>这里定义了两个可作为参数的变量，分别是主设备号和次设备号，<code>memcdev</code>是我们使用的字符设备，而<code>memcdev_fops</code>指定了对应的处理函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/kernel.h&gt;</span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/types.h&gt;</span><br><span class="line">#include &lt;linux/cdev.h&gt;</span><br><span class="line">#include &lt;linux/fcntl.h&gt;</span><br><span class="line">#include &lt;linux/slab.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;asm/uaccess.h&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;memcdev.h&quot;</span><br><span class="line"></span><br><span class="line">int memcdev_major = 0;	//主设备号,默认0表示由系统分配</span><br><span class="line">int memcdev_minor = 0;	//次设备号</span><br><span class="line">module_param(memcdev_major, int, S_IRUGO);</span><br><span class="line">module_param(memcdev_minor, int, S_IRUGO);</span><br><span class="line"></span><br><span class="line">struct memcdev *memcdev;</span><br><span class="line"></span><br><span class="line">struct file_operations memcdev_fops = &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.read = memcdev_read,</span><br><span class="line">	.write = memcdev_write,</span><br><span class="line">	.open = memcdev_open,</span><br><span class="line">	.release =  memcdev_release,</span><br><span class="line">	.llseek = memcdev_lseek,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="加载与卸载模块"><a href="#加载与卸载模块" class="headerlink" title="加载与卸载模块"></a>加载与卸载模块</h3><p>初始化函数的主要空间就是分配设备号和内存，我们这里分配了一块次设备号为0的设备。这里的清除函数我们并没有加<code>__exit</code>，因为我们在初始化失败时也会调用此函数来释放已经申请的内存。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">memcdev_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">dev_t</span> dev = MKDEV(memcdev_major, memcdev_minor);</span><br><span class="line">	<span class="comment">//移除字符设备</span></span><br><span class="line">	cdev_del(&amp;memcdev-&gt;cdev);</span><br><span class="line">	<span class="comment">//释放字符设备占的内存</span></span><br><span class="line">	kfree(memcdev);</span><br><span class="line">	<span class="comment">//释放设备编号</span></span><br><span class="line">	unregister_chrdev_region(dev, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	DPRINTF(<span class="string">"bye memcdev!\n"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//__init表示将代码段放到init section中,初始化完就移出内存</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">memcdev_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> devssize = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> memcdev);</span><br><span class="line">	<span class="keyword">dev_t</span> dev = MKDEV(memcdev_major, memcdev_minor);</span><br><span class="line">	<span class="comment">//如果用户手动设置了主设备号则使用用户设置的设备号</span></span><br><span class="line">	<span class="keyword">if</span> (memcdev_major) &#123;</span><br><span class="line">		retval = register_chrdev_region(dev, <span class="number">1</span>, <span class="string">"memcdev"</span>);</span><br><span class="line">	<span class="comment">//否则由系统动态来分配一个设备号</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		retval = alloc_chrdev_region(&amp;dev, memcdev_minor, <span class="number">1</span>, <span class="string">"memcdev"</span>);</span><br><span class="line">		memcdev_major = MAJOR(dev);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//上面两个分配函数如果返回小于0说明分配设备号失败</span></span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		DPRINTF(<span class="string">"Can't get memcdev major!\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//给字符设备分配空间</span></span><br><span class="line">	memcdev = kmalloc(devssize, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!memcdev) &#123;</span><br><span class="line">		retval = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memset</span>(memcdev, <span class="number">0</span>, devssize);</span><br><span class="line">	<span class="comment">//注册字符设备到内核</span></span><br><span class="line">	cdev_init(&amp;memcdev-&gt;cdev, &amp;memcdev_fops);</span><br><span class="line">	memcdev-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line">	memcdev-&gt;cdev.ops = &amp;memcdev_fops;</span><br><span class="line">	retval = cdev_add(&amp;memcdev-&gt;cdev, dev, <span class="number">1</span>);</span><br><span class="line">	<span class="comment">//返回非0表示添加设备失败</span></span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		DPRINTF(<span class="string">"Can't add dev memcdev\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DPRINTF(<span class="string">"hello memcdev!\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">	memcdev_exit();</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line">module_init(memcdev_init);</span><br><span class="line">module_exit(memcdev_exit);</span><br><span class="line"><span class="comment">//模块描述</span></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"swm8023"</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="打开与关闭文件"><a href="#打开与关闭文件" class="headerlink" title="打开与关闭文件"></a>打开与关闭文件</h3><p>打开时关联文件，并注意在只写模式打开时要截断文件。release操作只是为了调试打印了一句话，总能调用成功。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">memcdev_open</span><span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *filp)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//将文件与设备关联,将设备结构体放到文件的private_data字段里</span></span><br><span class="line">	<span class="keyword">struct</span> memcdev *dev = container_of(node-&gt;i_cdev, <span class="keyword">struct</span> memcdev, cdev);</span><br><span class="line">	filp-&gt;private_data = dev;</span><br><span class="line">	<span class="comment">//如果文件以只写模式打开,将文件内容清空</span></span><br><span class="line">	<span class="keyword">if</span> ((filp-&gt;f_flags &amp; O_ACCMODE) == O_WRONLY)</span><br><span class="line">		dev-&gt;size = <span class="number">0</span>;</span><br><span class="line">	DPRINTF(<span class="string">"opened\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">memcdev_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//没有操作直接retutn 0即可</span></span><br><span class="line">	DPRINTF(<span class="string">"closed\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="读写操作"><a href="#读写操作" class="headerlink" title="读写操作"></a>读写操作</h3><p>实际上是在对一块4K的内存进行读写，注意处理越界问题，并且要使用<code>copy_to_user</code>和<code>copy_from_user</code>在内核空间和用户空间之间传递数据。还有这里的偏移量传的是一个指针，我们要在函数中根据实际读写情况调整偏移量。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> memcdev_read(<span class="keyword">struct</span> file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *fpos) &#123;</span><br><span class="line">	<span class="keyword">struct</span> memcdev *dev = filp-&gt;private_data;</span><br><span class="line">	<span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//如果指针位置非法(超过文件大小)</span></span><br><span class="line">	<span class="keyword">if</span> (*fpos &gt;= dev-&gt;size)</span><br><span class="line">		<span class="keyword">goto</span> ret;</span><br><span class="line">	<span class="comment">//保证不会读越界(超过文件大小)</span></span><br><span class="line">	<span class="keyword">if</span> (*fpos + count &gt; dev-&gt;size) </span><br><span class="line">		count = dev-&gt;size - *fpos;</span><br><span class="line">	<span class="comment">//拷贝数据到用户空间</span></span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(buf, dev-&gt;mem + *fpos, count)) &#123;</span><br><span class="line">		retval = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//修改偏移量</span></span><br><span class="line">	*fpos += count;</span><br><span class="line">	retval = count;</span><br><span class="line">ret:</span><br><span class="line">	DPRINTF(<span class="string">"read size:%d\n"</span>, retval);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> memcdev_write(<span class="keyword">struct</span> file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *fpos) &#123;</span><br><span class="line">	<span class="keyword">struct</span> memcdev *dev = filp-&gt;private_data;</span><br><span class="line">	<span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//如果指针位置非法</span></span><br><span class="line">	<span class="keyword">if</span> (*fpos &gt;= BUFSIZE)</span><br><span class="line">		<span class="keyword">goto</span> ret;</span><br><span class="line">	<span class="comment">//保证不会写越界</span></span><br><span class="line">	<span class="keyword">if</span> (*fpos + count &gt; BUFSIZE)</span><br><span class="line">		count = BUFSIZE - *fpos;</span><br><span class="line">	<span class="comment">//拷贝数据到内核空间</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(dev-&gt;mem + *fpos, buf, count)) &#123;</span><br><span class="line">		retval = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//修改偏移量</span></span><br><span class="line">	*fpos += count;</span><br><span class="line">	retval = count;</span><br><span class="line">	<span class="comment">//修改文件大小</span></span><br><span class="line">	<span class="keyword">if</span> (dev-&gt;size &lt; *fpos)</span><br><span class="line">		dev-&gt;size = *fpos;</span><br><span class="line">ret:</span><br><span class="line">	DPRINTF(<span class="string">"write size:%d\n"</span>, retval);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="lseek操作"><a href="#lseek操作" class="headerlink" title="lseek操作"></a>lseek操作</h3><p>这里就是实现lseek函数的操作，这个偏移指针是可以超过文件大小的，但不能为负。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">loff_t</span> memcdev_lseek(<span class="keyword">struct</span> file *filp, <span class="keyword">loff_t</span> offset, <span class="keyword">int</span> whence) &#123;</span><br><span class="line">	<span class="keyword">struct</span> memcdev *dev = filp-&gt;private_data;</span><br><span class="line">	<span class="keyword">loff_t</span> newpos;</span><br><span class="line">	<span class="keyword">switch</span>(whence) &#123;</span><br><span class="line">		<span class="keyword">case</span> SEEK_SET:</span><br><span class="line">			newpos = offset;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> SEEK_CUR:</span><br><span class="line">			newpos = filp-&gt;f_pos + offset;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> SEEK_END:</span><br><span class="line">			newpos = dev-&gt;size +offset;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (newpos &lt; <span class="number">0</span>) <span class="keyword">return</span> -EINVAL;</span><br><span class="line">	DPRINTF(<span class="string">"lseek %lld-&gt;%lld\n"</span>, filp-&gt;f_pos, newpos);</span><br><span class="line">	<span class="keyword">return</span> filp-&gt;f_pos = newpos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><p>test.c是我写的测试文件，也放在一起Make了。前面<code>DEBUG = y</code>时开启调试输出。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = y</span><br><span class="line"></span><br><span class="line">ifeq ($(DEBUG),y)</span><br><span class="line">	DEBFLAGS = -O -DMEMC_DEBUG</span><br><span class="line">else</span><br><span class="line">	DEBFLAGS = -O2</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">EXTRA_CFLAGS += <span class="variable">$(DEBFLAGS)</span></span><br><span class="line"></span><br><span class="line">ifneq ($(KERNELRELEASE),)</span><br><span class="line"></span><br><span class="line">obj-m := memcdev.o</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">KERNELDIR ?= /lib/modules/<span class="variable">$(shell uname -r)</span>/build</span><br><span class="line">PWD := <span class="variable">$(shell pwd)</span></span><br><span class="line"></span><br><span class="line">all: module test</span><br><span class="line"><span class="section">module:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line">test: test.c</span><br><span class="line">	<span class="variable">$(CC)</span> -o test test.c</span><br><span class="line">endif</span><br></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong>测试</strong></h2><h3 id="创建设备"><a href="#创建设备" class="headerlink" title="创建设备"></a>创建设备</h3><p>运行以下脚本来加载<code>memcdev</code>内核模块并在<code>/dev</code>目录下创建一个特殊设备文件，该设备文件的读写会使用我们自己的字符驱动。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">module=<span class="string">"memcdev"</span></span><br><span class="line">device=<span class="string">"memcdev"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#加载内核模块</span></span><br><span class="line">/sbin/rmmod ./<span class="variable">$module</span>.ko</span><br><span class="line">/sbin/insmod ./<span class="variable">$module</span>.ko $* || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#找出设备的主设备号</span></span><br><span class="line">major=$(awk <span class="string">"\$2==\"<span class="variable">$module</span>\" &#123;print \$1&#125;"</span> /proc/devices)</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除已有的设备</span></span><br><span class="line">rm -rf /dev/<span class="variable">$&#123;device&#125;</span>0</span><br><span class="line"><span class="comment">#创建特殊设备</span></span><br><span class="line">mknod /dev/<span class="variable">$&#123;device&#125;</span>0 c <span class="variable">$major</span> 0</span><br></pre></td></tr></table></figure></p>
<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><p>测试文件内容如下，先尝试正常读写，再尝试写一个超过字符设备容量的串。这里我们并不在测试程序中直接打印结果，而是通过<code>dmesg</code>和<code>strace</code>工具来分别追踪内核空间和用户空间的运行情况。<br>我们使用<code>strace ./test</code>来运行程序，以获得调试输出。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZE 4096</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> wword[] = <span class="string">"Hello World!"</span>;</span><br><span class="line">	<span class="keyword">char</span> rword[BUFSIZE * <span class="number">2</span>];</span><br><span class="line">	<span class="keyword">size_t</span> n;</span><br><span class="line">	<span class="comment">//打开文件</span></span><br><span class="line">	<span class="keyword">int</span> fd = open(<span class="string">"/dev/memcdev0"</span>, O_RDWR);</span><br><span class="line">	<span class="comment">//写13个字节</span></span><br><span class="line">	write(fd, wword, <span class="keyword">sizeof</span>(wword));</span><br><span class="line">	<span class="comment">//将偏移移动到文件头</span></span><br><span class="line">	lseek(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	read(fd, rword, <span class="keyword">sizeof</span>(rword));</span><br><span class="line">	<span class="comment">//过量写</span></span><br><span class="line">	write(fd, rword, <span class="keyword">sizeof</span>(rword));</span><br><span class="line">	<span class="comment">//关闭文件</span></span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="dmesg"><a href="#dmesg" class="headerlink" title="dmesg"></a>dmesg</h3><p><code>dmesg</code>输出如下，其中前后两行是<code>insmod</code>和<code>rmmod</code>时打印的，中间一段是运行test程序时打印的，可以看到打开文件打开后首先写入了13个字节，然后将文件偏移移到开头，读取了13个字节刚刚写入的内容，下一次过量写时只写入了<code>4096-13=4083</code>个字节，最后程序<code>close</code>时调用了<code>release</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[32158.139396] MEMCDEV: hello memcdev!</span><br><span class="line">[32171.598513] MEMCDEV: opened</span><br><span class="line">[32171.598540] MEMCDEV: write size:13</span><br><span class="line">[32171.598559] MEMCDEV: lseek 13-&gt;0</span><br><span class="line">[32171.598577] MEMCDEV: read size:13</span><br><span class="line">[32171.598610] MEMCDEV: write size:4083</span><br><span class="line">[32171.598628] MEMCDEV: closed</span><br><span class="line">[32193.212250] MEMCDEV: bye memcdev!</span><br></pre></td></tr></table></figure></p>
<h3 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h3><p><code>steace ./test</code>输出内容很多，前面一堆都不用管，后面那几行是运行那几句代码时的用户空间调用及其返回值。可以看到调用返回与<code>dmesg</code>打印的内容完全一致。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">open(&quot;/dev/memcdev0&quot;, O_RDWR)           = 3</span><br><span class="line">write(3, &quot;Hello World!\0&quot;, 13)          = 13</span><br><span class="line">lseek(3, 0, SEEK_SET)                   = 0</span><br><span class="line">read(3, &quot;Hello World!\0&quot;, 8192)         = 13</span><br><span class="line">write(3, &quot;Hello World!\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;..., 8192) = 4083</span><br><span class="line">close(3)                                = 0</span><br></pre></td></tr></table></figure>
<h2 id="OVER"><a href="#OVER" class="headerlink" title="OVER"></a><strong>OVER</strong></h2><p>到这里一个最简单的字符设备驱动就完成了，但它是有很多问题的，比如并发问题等等。之后我将随着学习的过程逐渐完善这个程序。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/blog/2013/12/02/linuxdrivecode-cdev/">Linux设备驱动学习——简单字符设备驱动的实现</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 Vimer Su 的个人博客">Vimer Su</a></p>
        <p><span>发布时间:</span>2013年12月02日 - 19时19分</p>
        <p><span>最后更新:</span>2016年06月04日 - 22时57分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/blog/2013/12/02/linuxdrivecode-cdev/" title="Linux设备驱动学习——简单字符设备驱动的实现">http://vimersu.win/blog/2013/12/02/linuxdrivecode-cdev/</a>
            <span class="copy-path" data-clipboard-text="原文: http://vimersu.win/blog/2013/12/02/linuxdrivecode-cdev/　　作者: Vimer Su" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/blog/2014/01/11/struct-alignment/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          C的结构体字节对齐
        
      </div>
    </a>
  
  
    <a href="/blog/2013/11/30/linux-sublimetext-chinese/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">解决Linux下Sublime text 3的中文输入问题</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备知识"><span class="toc-number">1.</span> <span class="toc-text">准备知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设备号"><span class="toc-number">1.1.</span> <span class="toc-text">设备号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字符设备注册"><span class="toc-number">1.2.</span> <span class="toc-text">字符设备注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件操作"><span class="toc-number">1.3.</span> <span class="toc-text">文件操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码实现"><span class="toc-number">2.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#结构体与函数原型"><span class="toc-number">2.1.</span> <span class="toc-text">结构体与函数原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Begin"><span class="toc-number">2.2.</span> <span class="toc-text">Begin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加载与卸载模块"><span class="toc-number">2.3.</span> <span class="toc-text">加载与卸载模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#打开与关闭文件"><span class="toc-number">2.4.</span> <span class="toc-text">打开与关闭文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读写操作"><span class="toc-number">2.5.</span> <span class="toc-text">读写操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lseek操作"><span class="toc-number">2.6.</span> <span class="toc-text">lseek操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Makefile"><span class="toc-number">2.7.</span> <span class="toc-text">Makefile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">3.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建设备"><span class="toc-number">3.1.</span> <span class="toc-text">创建设备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试代码"><span class="toc-number">3.2.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dmesg"><span class="toc-number">3.3.</span> <span class="toc-text">dmesg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#strace"><span class="toc-number">3.4.</span> <span class="toc-text">strace</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OVER"><span class="toc-number">4.</span> <span class="toc-text">OVER</span></a></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>







    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="blog/2013/12/02/linuxdrivecode-cdev/" data-title="Linux设备驱动学习——简单字符设备驱动的实现" data-url="http://vimersu.win/blog/2013/12/02/linuxdrivecode-cdev/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"c4fun"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = '/js/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    



    <div class="scroll" id="post-nav-button">
        
            <a href="/blog/2014/01/11/struct-alignment/" title="上一篇: C的结构体字节对齐">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/blog/2013/11/30/linux-sublimetext-chinese/" title="下一篇: 解决Linux下Sublime text 3的中文输入问题">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/04/dx-lesson02-3dknowledge/">DirectX 3D学习笔记02——3D数学基础</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/03/dx-lesson01-window/">DirectX 3D学习笔记01——环境搭建与窗口创建</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2015/10/03/osx-xcode-opengl/">在OSX中进行OpenGL开发</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2015/06/23/xcode64-alactraz-bug/">Xcode6.4中Alcatraz无法启动</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2015/06/23/vim-base-operation/">Vim基础操作汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2015/06/13/apache-reverse-proxy/">通过Apache反向代理访问本地Gogs服务</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2015/06/09/mac-another-screen/">Macbook修改外接显示器分辨率</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/12/12/how-to-use-define/">宏的拓展用法总结</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/12/06/cmockery/">C单元测试框架之Cmockery</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/10/10/maven-study/">Linux下Maven的安装与使用</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/05/06/python-threading/">python中的多线程</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/03/23/python-regular/">python正则表达式</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/03/20/leetcode-solution-02/">LeetCode题解整理版(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/03/18/leetcode-solution-01/">LeetCode题解整理版(一) </a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/03/12/heap-template/">一个用宏实现的堆模板</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/03/06/libev-study/">Libev事件库源码阅读笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/03/04/linux-iconv/">在Linux下使用iconv转换字符串编码</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/03/03/use-hexo-blog/">使用Hexo搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/01/30/common-makefile/">一个通用的C/C++ Makefile</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/01/23/gnu-make-study02/">GNU Make学习总结（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/01/13/gnu-make-study01/">GNU Make学习总结（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2014/01/11/struct-alignment/">C的结构体字节对齐</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/12/02/linuxdrivecode-cdev/">Linux设备驱动学习——简单字符设备驱动的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/30/linux-sublimetext-chinese/">解决Linux下Sublime text 3的中文输入问题</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/25/start-leetcode-oj/">开始刷LeetCode OJ</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/24/octopress-generate-post-content/">让Octopress为文章自动生成目录</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/23/wlanconfig-tools-source/">wlanconfig工具分析</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/22/auto-aixiaochu-app/">Qt+BlueStack实现自动天天爱消除</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/21/binary-tree-nonrecursive-traversal/">另一种二叉树非递归遍历的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/19/linux-io-reuse-interface/">Linux中的IO复用接口简介</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/19/linux-ap-by-madwifi/">Linux下使用无线网卡搭建AP</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2013/11/19/hello-octopress/">开启OctoPress之旅</a></li></ul>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 Vimer Su
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
    </div>
</footer>

    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>